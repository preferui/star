(function(){if(!location.pathname.match(/\/(\d{4}\/\d{2}\/|p\/)/))return;const ratingSection=document.querySelector(".ghRating-section");if(!ratingSection||typeof ghRatings==="undefined")return;const firebaseUrl=(ghRatings.firebaseUrl||"").replace(/\/$/,"");const avgScoreEl=ratingSection.querySelector("#avgScore");const starsAverageEl=ratingSection.querySelector("#starsAverage");const totalRatingEl=ratingSection.querySelector(".total-rating .total");const ratedCaption=ratingSection.querySelector(".rated-caption");const progressBars=ratingSection.querySelectorAll(".rating-progress");let fingerprint='',alreadyRated=false,blogId='',postId='';function getFingerprint(){try{const c=document.createElement("canvas"),x=c.getContext("2d");x.textBaseline="top";x.font="14px Arial";x.fillText(navigator.userAgent,2,2);return btoa(c.toDataURL()).slice(0,32)}catch{return"anonymous"}}function getBloggerPostInfo(cb){const i=setInterval(()=>{if(window._WidgetManager&&typeof _WidgetManager._GetAllData==="function"){clearInterval(i);try{const d=_WidgetManager._GetAllData();const b="BlogID_"+d.blog.blogId,p="PostID_"+d.blog.postId;cb(b,p)}catch(e){console.error("Không thể lấy BlogID/PostID:",e)}}},100)}function renderStars(a){starsAverageEl.innerHTML='';for(let i=1;i<=5;i++){let p=Math.min(100,Math.max(0,(a-i+1)*100));const s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.setAttribute("viewBox","0 0 24 24");s.innerHTML=`<defs><linearGradient id="grad${i}"x1="0%"y1="0%"x2="100%"y2="0%"><stop offset="${p}%"stop-color="#e0ac33"/><stop offset="${p}%"stop-color="#ccc"/></linearGradient></defs><path fill="url(#grad${i})"d="M12.587l3.668 7.431L24 9.423l-6 5.849 1.417 8.268L12 18.897 4.583 23.54 6 15.272 0 9.423l8.332-1.405z"/>`;starsAverageEl.appendChild(s);s.addEventListener("click",()=>{if(!alreadyRated){submitRating(i)}})}avgScoreEl.textContent=a.toFixed(1)}function updateUI(d){const c=d?.count||0,s=d?.sum||0,f=d?.fingerprints||{},a=c?s/c:0;renderStars(a);totalRatingEl.textContent=c;const rc={1:0,2:0,3:0,4:0,5:0};for(let fp in f){let r=parseInt(f[fp]);if(r>=1&&r<=5)rc[r]++}progressBars.forEach(b=>{const r=parseInt(b.getAttribute("data-rate"));const cp=rc[r]||0,per=c?((cp/c)*100).toFixed(1):0;const bar=b.querySelector(".progress-bar"),v=b.querySelector(".votes");if(bar)bar.style.width=`${per}%`;if(v)v.textContent=cp});if(f[fingerprint]){alreadyRated=true;ratedCaption.classList.remove("hidden")}}function fetchRating(){fetch(`${firebaseUrl}/ghRatings/${blogId}/${postId}.json`).then(r=>r.json()).then(updateUI)}function submitRating(v){fetch(`${firebaseUrl}/ghRatings/${blogId}/${postId}.json`).then(r=>r.json()).then(d=>{const c=d?.count||0,s=d?.sum||0,f=d?.fingerprints||{};if(f[fingerprint])return;const n={sum:s+v,count:c+1,fingerprints:{...f,[fingerprint]:v}};return fetch(`${firebaseUrl}/ghRatings/${blogId}/${postId}.json`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})}).then(()=>{alreadyRated=true;ratedCaption.classList.remove("hidden");fetchRating()})}fingerprint=getFingerprint();getBloggerPostInfo((b,p)=>{blogId=b;postId=p;fetchRating()})})();
